---
import { reactify } from "@/utils/reactify";
var { label, items, checkedItems, onUpdate } = Astro.props;

const x_data = `{
  ${reactify(items, "items")},
  ${reactify(checkedItems, "checkedItems")},
  checkedItemsUpdated: [],
  ${reactify(onUpdate, "onUpdate")},
  isOpen: false, 
  openedWithKeyboard: false
}`;
---

<div
  x-data={x_data}
  class="flex
        flex-col
        relative
        w-full"
  x-init="$watch('checkedItems', value => {
    checkedItemsUpdated = Array.from(checkedItems); 
  });"
  x-on:keydown.esc.window="isOpen = false, openedWithKeyboard = false"
>
  {
    label ? (
      <label class="w-fit pl-0.5 pt-0.5 text-sm text-gray-400">{label}</label>
    ) : (
      <div class="h-5" />
    )
  }

  <!-- Toggle Button -->
  <button
    type="button"
    x-on:click="isOpen = ! isOpen;"
    class="bg-transparent
                rounded-lg
                w-full
                border-2 border-primary
                px-3 py-2
                block
                text-sm font-medium
                text-primary
                text-left
                tracking-wide
                transition
                cursor-pointer
                hover:opacity-75
                focus-visible:outline-2
                focus-visible:outline-offset-2
                focus-visible:outline-primary
                active:opacity-100
                active:outline-offset-0
                disabled:opacity-75
                disabled:cursor-not-allowed
                dark:border-low-contrast-grey
                dark:text-primary-dark
                dark:focus-visible:outline-primary-dark"
    aria-haspopup="true"
    x-on:keydown.space.prevent="openedWithKeyboard = true"
    x-on:keydown.enter.prevent="openedWithKeyboard = true"
    x-on:keydown.down.prevent="openedWithKeyboard = true"
    x-bind:class="isOpen || openedWithKeyboard ? 'text-on-surface-strong dark:text-on-surface-dark-strong' : 'text-on-surface dark:text-on-surface-dark'"
    x-bind:aria-expanded="isOpen || openedWithKeyboard"
  >
    <div class="flex items-center justify-between gap-2 w-full">
      <span
        x-text="checkedItems.length == 0 ? 'No items selected' : checkedItems.join(', ')"
        class="w-full truncate"></span>

      <svg
        aria-hidden="true"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        stroke-width="2"
        stroke="currentColor"
        class="size-4 rotate-0 justify-self-end"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
      </svg>
    </div>
  </button>

  <!-- Dropdown Menu -->
  <div
    x-cloak
    x-show="isOpen || openedWithKeyboard"
    x-transition
    x-trap="openedWithKeyboard"
    x-on:click.outside="isOpen = false, openedWithKeyboard = false"
    x-on:keydown.down.prevent="$focus.wrap().next()"
    x-on:keydown.up.prevent="$focus.wrap().previous()"
    class="absolute
            py-1
            flex w-full flex-col
            overflow-hidden rounded-radius
            border border-outline
            backdrop-blur-md
            dark:border-low-contrast-grey
            dark:bg-surface-dark-alt
            rounded-lg
            z-10"
    role="menu"
  >
    <template x-for="item in items">
      <div
        class="flex items-center
              gap-3
              px-4 py-2
              select-none
              hover:opacity-75
              cursor-pointer"
        @click={` 
              if (checkedItemsUpdated.includes(item)) {
                checkedItemsUpdated = checkedItemsUpdated.filter(checkedItem => checkedItem != item);
                
              } else {
                checkedItemsUpdated.push(item);
              }
                
              onUpdate(checkedItemsUpdated)
            `}
      >
        <input
          type="checkbox"
          :checked="checkedItems.includes(item)"
          :value="item"
          class="h-4 w-4
                  rounded
                border-gray-300
                  text-primary
                  pointer-events-none
                  focus:ring-primary
                  flex-shrink-0"
        />
        <label x-text="item" class="ml-0.5 cursor-pointer text-sm"></label>
      </div>
    </template>
  </div>
</div>
