---
import { Image } from "astro:assets";
var { user_profile_pic } = Astro.props;
---

<!-- Fetch user information and set profile picture -->
<script>
  async function getUser() {
    try {
      const response = await fetch("/api/user");
      if (!response.ok) {
        throw new Error(`Response status: ${response.status}`);
      }

      return await response.json();
    } catch (error: any) {
      console.error(error.message);
    }
  }

  async function changeProfilePicture() {
    const user = await getUser();
    const user_profile_pic = document.getElementById("user_profile_pic");

    if (user_profile_pic) {
      user_profile_pic.setAttribute("referrerpolicy", "no-referrer");
      user_profile_pic.setAttribute("src", user.picture);
    }
  }

  // As the header is always visible, should only need to do this on page-load not every
  // swap
  document.addEventListener("astro:page-load", changeProfilePicture);
</script>

<!-- navigation implementation goes here -->
<nav
  x-data="{ mobileMenuIsOpen: false }"
  x-on:click.away="mobileMenuIsOpen = false"
  class="flex items-center justify-between pr-4 pl-2 py-4"
  aria-label="penguin ui menu"
>
  <!-- Brand Logo -->
  <a href="/">
    <Image
      src="/images/coach_craft_logo.svg"
      alt="brand logo"
      width="80"
      height="80"
    />
  </a>

  <div class="flex flex-row">
    <!-- team colors container -->
    <div class="pr-5 flex items-end">
      <div class="flex flex-col items-end">
        <div class="flex h-5">
          <div class="w-7 rounded-l-sm -skew-x-25 bg-team-green"></div>
          <div class="w-7 ml-0.5 -skew-x-25 bg-team-yellow"></div>
          <div class="w-7 ml-0.5 -skew-x-25 bg-team-white"></div>
          <div class="w-7 ml-0.5 rounded-r-sm -skew-x-25 bg-team-red"></div>
        </div>
        <span class="text-xs mt-0.5">Mayfield United JSFC</span>
      </div>
    </div>

    <!-- profile button -->
    <li
      x-data="{ userDropDownIsOpen: false, openWithKeyboard: false }"
      x-on:keydown.esc.window="userDropDownIsOpen = false, openWithKeyboard = false"
      class="hidden
            sm:relative
            sm:flex
            sm:items-center"
    >
      <button
        x-on:click="userDropDownIsOpen = ! userDropDownIsOpen"
        x-bind:aria-expanded="userDropDownIsOpen"
        x-on:keydown.space.prevent="openWithKeyboard = true"
        x-on:keydown.enter.prevent="openWithKeyboard = true"
        x-on:keydown.down.prevent="openWithKeyboard = true"
        class="focus-visible:outline-2
              focus-visible:outline-offset-2
              focus-visible:outline-primary
              dark:focus-visible:outline-primary-dark
              cursor-pointer"
        aria-controls="userMenu"
      >
        <Image
          id="user_profile_pic"
          src="/images/profile_icon.png"
          alt="User Profile"
          width="50"
          height="50"
          class="relative z-10 border-3 border-bg-black rounded-full"
        />
        <Image
          src="/images/team_icon.png"
          alt="Team icon"
          width="50"
          height="50"
          class="absolute top-0 left-6 border-6 border-bg-black rounded-full"
        />
      </button>

      <!-- profile dropdown -->
      <ul
        x-cloak
        x-show="userDropDownIsOpen || openWithKeyboard"
        x-transition.opacity
        x-trap="openWithKeyboard"
        x-on:click.outside="userDropDownIsOpen = false, openWithKeyboard = false"
        x-on:keydown.down.prevent="$focus.wrap().next()"
        x-on:keydown.up.prevent="$focus.wrap().previous()"
        id="userMenu"
        class="absolute
              top-15 -right-5
              flex w-fit min-w-48 flex-col
              overflow-hidden rounded-radius
              border border-outline
              backdrop-blur-xs
              py-1
              dark:border-low-contrast-grey
              dark:bg-surface-dark-alt
              rounded-lg
              z-10"
      >
        <li class="border-b border-outline dark:border-low-contrast-grey">
          <div class="flex flex-col px-4 py-2">
            <span
              class="text-sm font-medium text-on-surface-strong dark:text-on-surface-dark-strong"
              >Stuart</span
            >
            <p class="text-xs text-on-surface dark:text-on-surface-dark">
              stuart@gmail.com
            </p>
          </div>
        </li>
        <li>
          <a
            href="/logout"
            class="block
                  bg-surface-alt
                  px-4 py-2
                  text-sm
                  text-on-surface
                  hover:cursor-pointer
                  hover:bg-surface-dark-alt/5
                  hover:text-on-surface-strong
                  focus-visible:bg-surface-dark-alt/10
                  focus-visible:text-on-surface-strong
                  focus-visible:outline-hidden
                  dark:bg-surface-dark-alt
                  dark:text-on-surface-dark
                  dark:hover:bg-surface-alt/5
                  dark:hover:text-on-surface-dark-strong
                  dark:focus-visible:bg-surface-alt/10
                  dark:focus-visible:text-on-surface-dark-strong"
            >Sign Out</a
          >
        </li>
      </ul>
    </li>

    <!-- mobile profile button -->
    <button
      x-on:click="mobileMenuIsOpen = !mobileMenuIsOpen"
      x-bind:aria-expanded="mobileMenuIsOpen"
      x-bind:class="mobileMenuIsOpen ? 'fixed top-6 right-6 z-20' : null"
      type="button"
      class="flex
            text-on-surface
            dark:text-on-surface-dark
            sm:hidden"
      aria-label="mobile menu"
      aria-controls="mobileMenu"
    >
      <svg
        x-cloak
        x-show="!mobileMenuIsOpen"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        aria-hidden="true"
        viewBox="0 0 24 24"
        stroke-width="2"
        stroke="currentColor"
        class="size-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path>
      </svg>
      <svg
        x-cloak
        x-show="mobileMenuIsOpen"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        aria-hidden="true"
        viewBox="0 0 24 24"
        stroke-width="2"
        stroke="currentColor"
        class="size-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18 18 6M6 6l12 12"></path>
      </svg>
    </button>

    <!-- mobile profile dropdown -->
    <ul
      x-cloak
      x-show="mobileMenuIsOpen"
      x-transition:enter="transition motion-reduce:transition-none ease-out duration-300"
      x-transition:enter-start="-translate-y-full"
      x-transition:enter-end="translate-y-0"
      x-transition:leave="transition motion-reduce:transition-none ease-out duration-300"
      x-transition:leave-start="translate-y-0"
      x-transition:leave-end="-translate-y-full"
      class="fixed
            inset-x-0
            top-12
            z-10
            max-h-svh
            overflow-y-auto
            flex flex-col
            rounded-b-radius border-b border-outline
            bg-surface-alt
            px-8 pb-6 pt-10
            dark:border-outline-dark
            dark:bg-surface-dark-alt
            sm:hidden"
    >
      <li class="mb-4 border-none">
        <div class="flex items-center gap-2 py-2">
          <Image
            src="/images/profile_icon.png"
            alt="User Profile"
            width="55"
            height="55"
          />
          <div>
            <span
              class="font-medium text-on-surface-strong dark:text-on-surface-dark-strong"
              >Stuart</span
            >
            <p class="text-sm text-on-surface dark:text-on-surface-dark">
              stuart@gmail.com
            </p>
          </div>
        </div>
      </li>
      <hr role="none" class="my-2 border-outline dark:border-outline-dark" />
      <li class="mt-4 w-full border-none">
        <a
          href="/"
          class="rounded-radius
                bg-primary
                border-primary
                px-4 py-2
                block
                text-center
                font-medium tracking-wide text-on-primary
                hover:opacity-75
                focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary
                active:opacity-100 active:outline-offset-0
                dark:bg-primary-dark
                dark:border-primary-dark
                dark:text-on-primary-dark
                dark:focus-visible:outline-primary-dark"
        >
          Dashboard
        </a>
        <a
          href="/activities/"
          class="rounded-radius
                bg-primary
                border-primary
                px-4 py-2
                block
                text-center
                font-medium tracking-wide text-on-primary
                hover:opacity-75
                focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary
                active:opacity-100 active:outline-offset-0
                dark:bg-primary-dark
                dark:border-primary-dark
                dark:text-on-primary-dark
                dark:focus-visible:outline-primary-dark"
        >
          Activities
        </a>
        <a
          href="/notes/"
          class="rounded-radius
                bg-primary
                border-primary
                px-4 py-2
                block
                text-center
                font-medium tracking-wide text-on-primary
                hover:opacity-75
                focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary
                active:opacity-100 active:outline-offset-0
                dark:bg-primary-dark
                dark:border-primary-dark
                dark:text-on-primary-dark
                dark:focus-visible:outline-primary-dark"
        >
          Notes
        </a>
        <a
          href="/scheduling/"
          class="rounded-radius
                bg-primary
                border-primary
                px-4 py-2
                block
                text-center
                font-medium tracking-wide text-on-primary
                hover:opacity-75
                focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary
                active:opacity-100 active:outline-offset-0
                dark:bg-primary-dark
                dark:border-primary-dark
                dark:text-on-primary-dark
                dark:focus-visible:outline-primary-dark"
        >
          Scheduling
        </a>
        <a
          href="/settings/"
          class="rounded-radius
                bg-primary
                border-primary
                px-4 py-2
                block
                text-center
                font-medium tracking-wide text-on-primary
                hover:opacity-75
                focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary
                active:opacity-100 active:outline-offset-0
                dark:bg-primary-dark
                dark:border-primary-dark
                dark:text-on-primary-dark
                dark:focus-visible:outline-primary-dark"
        >
          Settings
        </a>
        <a
          href="#"
          class="rounded-radius
                bg-primary
                border-primary
                px-4 py-2
                block
                text-center
                font-medium tracking-wide text-on-primary
                hover:opacity-75
                focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary
                active:opacity-100 active:outline-offset-0
                dark:bg-primary-dark
                dark:border-primary-dark
                dark:text-on-primary-dark
                dark:focus-visible:outline-primary-dark"
        >
          Sign Out
        </a>
      </li>
    </ul>
  </div>
</nav>
