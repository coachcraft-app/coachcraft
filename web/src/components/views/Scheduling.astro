---
import TextInput from "@/components/common/TextInput.astro";
import TextArea from "@/components/common/TextArea.astro";
import Button from "@/components/common/Button.astro";
import DropDown from "@/components/common/DropDown.astro";
---

<div class="flex h-full" x-data="{ scheduling: $store.scheduling, teams: $store.teams, activities: $store.activities, showConfirm: false, sessionToLoad: null }">
  <!-- Left pane: Current Schedule -->
  <div
    class="w-1/2 p-4 border-r border-gray-600"
    @dragover.prevent="scheduling.handleDragOver($event)"
    @drop="scheduling.handleDrop($event)"
  >
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl">Current Schedule</h2>
    </div>

    <form
      @submit.prevent="scheduling.saveSession(event)"
      class="flex flex-col gap-4"
    >
      <div class="flex flex-col gap-4">
        <TextInput
          name="sessionName"
          label="Schedule Name"
          required
          placeholder="Schedule Name"
          value="scheduling.sessionName"
        />
        <TextInput
          name="sessionDate"
          label="Date"
          required
          type="date"
          placeholder="DD-MM-YYYY"
          value="scheduling.sessionDate"
        />
        <div class="flex flex-col gap-1">
          <label class="w-fit pl-0.5 text-sm text-gray-400">Team</label>
          <select
            class="bg-gray-900 text-white border border-white rounded-lg px-2 py-1"
            x-model="scheduling.selectedTeam"
          >
            <template
              x-for="team in teams.teamsList"
              :key="team.id"
            >
              <option :value="team.id" x-text="team.name"></option>
            </template>
          </select>
        </div>
        <TextArea
          name="sessionNotes"
          label="Notes"
          placeholder="Add any notes or additional information about this schedule"
          rows="4"
          value="scheduling.sessionNotes"
        />
      </div>

      <template x-if="!scheduling.sessionActivities.length">
        <p class="text-gray-400">
          Drag activities here to assemble your session.
        </p>
      </template>

      <ul class="space-y-2">
        <template
          x-for="(act, idx) in scheduling.sessionActivities"
          :key="act.id"
        >
          <li class="flex justify-between items-center p-2 bg-gray-700 rounded">
            <div class="flex items-center gap-2">
              <div class="flex flex-col">
                <button
                  type="button"
                  class="text-gray-400 hover:text-white"
                  @click="scheduling.moveActivityUp(idx)"
                  :disabled="idx === 0"
                  aria-label="Move activity up">&uarr;</button
                >
                <button
                  type="button"
                  class="text-gray-400 hover:text-white"
                  @click="scheduling.moveActivityDown(idx)"
                  :disabled="idx === scheduling.sessionActivities.length - 1"
                  aria-label="Move activity down">&darr;</button
                >
              </div>
              <div class="flex flex-col">
                <span x-text="act.name" class="font-medium"></span>
                <span x-text="act.duration" class="text-sm text-gray-400"
                ></span>
              </div>
            </div>
            <Button
              type="button"
              label="Remove"
              width="fit"
              onClick="scheduling.removeFromSession(idx)"
            />
          </li>
        </template>
      </ul>

      <Button type="submit" label="Save Session" width="fit" />
    </form>
  </div>

  <!-- Right pane: Tabs -->
  <div class="w-1/2 p-4">
    <div class="flex border-b border-gray-600">
      <button
        class="px-4 py-2"
        :class="{'border-b-2 border-white': scheduling.selectedTab==='lists'}"
        @click="scheduling.switchTab('lists')">Lists</button
      >
      <button
        class="px-4 py-2"
        :class="{'border-b-2 border-white': scheduling.selectedTab==='last'}"
        @click="scheduling.switchTab('last')">Last Session</button
      >
      <button
        class="px-4 py-2"
        :class="{'border-b-2 border-white': scheduling.selectedTab==='history'}"
        @click="scheduling.switchTab('history')">History</button
      >
    </div>

    <!-- LISTS TAB -->
    <div x-cloak x-show="scheduling.selectedTab==='lists'" class="mt-4">
      <DropDown
        options="activities.listsNames"
        defaultOption="All Activities"
        onOptionSwitch="activities.onListSwitch(listToSelect)"
      />
      <ul class="mt-2 space-y-2">
        <template
          x-for="activity in activities.selectedListActivities"
          :key="activity.id"
        >
          <li
            class="p-2 bg-gray-800 rounded cursor-grab hover:bg-gray-700 transition-colors"
            draggable="true"
            @dragstart="scheduling.handleDragStart($event, activity)"
          >
            <div class="flex justify-between items-center">
              <span x-text="activity.name" class="font-medium"></span>
              <span class="text-sm text-gray-400" x-text="activity.duration"
              ></span>
            </div>
          </li>
        </template>
      </ul>
    </div>

    <!-- LAST SESSION TAB -->
    <div x-cloak x-show="scheduling.selectedTab==='last'" class="mt-4">
      <div class="mb-4">
        <h3 class="text-lg font-medium">
          <span x-text="scheduling.lastSession.name"></span>
        </h3>
        <div class="text-sm text-gray-400 mt-1">
          <span x-text="scheduling.lastSession.date"></span>
        </div>
        <p
          class="text-sm text-gray-400 mt-2"
          x-text="scheduling.lastSession.notes"
        >
        </p>
        <p class="text-sm text-gray-400 mt-2">
          Team: <span
            x-text="scheduling.lastSession.team ? teams.teamsList.find(t => t.id === scheduling.lastSession.team)?.name : '---'"
          ></span>
        </p>
      </div>
      <ul class="space-y-2">
        <!-- Last session activities sessions now use full activity objects -->
        <template
          x-for="(activity, activityIndex) in scheduling.lastSession.activities"
          :key="activity.id"
        >
          <li
            class="p-2 bg-gray-800 rounded cursor-grab hover:bg-gray-700 transition-colors"
            draggable="true"
            @dragstart="scheduling.handleDragStart($event, activity)"
          >
            <div class="flex justify-between items-center">
              <!-- Display activity name from the copied activity object -->
              <span x-text="activity.name"></span>
              <!-- Disply actvity duration from the copied activity object -->
              <span
                class="text-sm text-gray-400"
                x-text="activity.duration"
              ></span>
            </div>
          </li>
        </template>
      </ul>
      <button
        class="mt-3 px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 transition-colors"
        @click="sessionToLoad = scheduling.lastSession; showConfirm = true"
      >
        Load Session
      </button>
      <div
        x-cloak
        x-show="showConfirm"
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center backdrop-blur-sm"
      >
        <div
          class="bg-gray-800 p-6 rounded shadow-lg w-full max-w-sm text-center"
        >
          <p class="mb-6 text-white">
            Loading a session will remove current activities. Continue?
          </p>
          <div class="flex justify-center gap-4">
            <button
              type="button"
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
              @click="scheduling.loadSession(sessionToLoad); showConfirm = false"
            >
              Confirm
            </button>
            <button
              type="button"
              class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
              @click="showConfirm = false"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORY TAB -->
    <div
      x-cloak
      x-show="scheduling.selectedTab==='history'"
      class="mt-4"
    >
      <ul class="space-y-2">
        <template
          x-for="sess in scheduling.previousSessions"
          :key="sess.id"
        >
          <li
            class="flex flex-col p-2 bg-gray-800 rounded hover:bg-gray-900 transition-colors cursor-pointer"
            @click="scheduling.toggleSessionDetails(sess.id)"
          >
            <div class="flex justify-between items-center">
              <div>
                <span x-text="sess.name" class="font-medium"></span>
                <span x-text="sess.date" class="text-sm text-gray-400 ml-2"
                ></span>
              </div>
            </div>

            <!-- Expanded Details -->
            <div
              x-cloak
              x-show="scheduling.expandedSessions[sess.id]"
              x-transition
              class="mt-2 pt-2 border-t border-gray-600"
            >
              <p x-text="sess.notes" class="text-sm text-gray-400 mb-2"></p>
              <p class="text-sm text-gray-400 mb-2">
                Team: <span
                  x-text="sess.team ? teams.teamsList.find(t => t.id === sess.team)?.name : '---'"
                ></span>
              </p>
              <!-- Activities list in history all sessions use full activity objects -->
              <ul class="space-y-1">
                <template x-for="(activity, activityIndex) in sess.activities" :key="activity.id">
                  <li
                    class="p-2 bg-gray-700 rounded cursor-grab hover:bg-gray-600 transition-colors"
                    draggable="true"
                    @dragstart="scheduling.handleDragStart($event, activity)"
                  >
                    <div class="flex justify-between items-center">
                      <!-- Display activity name from the copied activity object -->
                      <span x-text="activity.name"></span>
                      <!-- Dsplay duration from the copied activity object -->
                      <span
                        x-text="activity.duration"
                        class="text-sm text-gray-400"></span>
                    </div>
                  </li>
                </template>
              </ul>
              <button
                class="mt-2 px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 transition-colors"
                @click="sessionToLoad = sess; showConfirm = true"
              >
                Load Session
              </button>
            </div>
          </li>
        </template>
      </ul>
      <div
        x-cloak
        x-show="showConfirm"
        class="fixed inset-0 z-50 flex items-center justify-center backdrop-blur-sm"
      >
        <div
          class="bg-gray-800 p-6 rounded shadow-lg w-full max-w-sm text-center"
        >
          <p class="mb-6 text-white">
            Loading a session will remove current activities. Continue?
          </p>
          <div class="flex justify-center gap-4">
            <button
              type="button"
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
              @click="scheduling.loadSession(sessionToLoad); showConfirm = false"
            >
              Confirm
            </button>
            <button
              type="button"
              class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
              @click="showConfirm = false"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
